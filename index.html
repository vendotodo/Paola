
<!doctype html>
<html lang="es">
<head>
  <link rel="icon" href="static/images/icons8-box-16.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Catálogo de productos - Vendo Todo por Paola">
  <title>Vendo Todo - Paola</title>
  <link rel="stylesheet" href="static/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Encabezado principal -->
  <header class="header">
    <div class="container">
      <div class="brand">
        <div class="logo">JB</div>
        <div>
          <div class="site-title">Vendo Todo</div>
          <div style="color:var(--muted); font-size:13px">Si te interesa algo, me mandas mensaje</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Controles de búsqueda y ordenamiento -->
  <main class="container" style="padding-top:18px">
    <div class="controls">
      <input id="search" class="search" placeholder="Buscar por nombre..." style="flex:1" aria-label="Buscar producto por nombre" />
      <select id="sort" class="select" aria-label="Ordenar productos">
        <option value="none">Ordenar por</option>
        <option value="price_asc">Precio ↑</option>
        <option value="price_desc">Precio ↓</option>
        <option value="name_asc">Nombre A→Z</option>
        <option value="name_desc">Nombre Z→A</option>
      </select>
    </div>

    <!-- Catálogo dinámico -->
    <div id="catalog" class="grid"></div>
    <p id="emptyMessage" style="display:none; text-align:center; color:#666">No se encontraron productos</p>
  </main>

  <!-- Overlay con carrusel -->
  <div id="productOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="overlay-content">
      <button class="close-btn" onclick="closeOverlay()" aria-label="Cerrar">&times;</button>
      <div class="carousel">
        <button id="prevBtn" class="prev-btn" onclick="changeSlide(-1)" aria-label="Imagen anterior">&#10094;</button>
        <div class="carousel-images" id="carouselImages"></div>
        <button id="nextBtn" class="next-btn" onclick="changeSlide(1)" aria-label="Imagen siguiente">&#10095;</button>
      </div>
      <h2 id="overlayName"></h2>
      <p id="overlayDescription"></p>
      <p id="overlaySize"></p>
      <p id="overlayPrice"></p>
    </div>
  </div>
  <div>
    <p style="text-align:center; font-size:12px;">
      <span style="color:gray;">Última actualización:</span>
      <span style="color:#001f3f;">25/11/2025 23:47</span>
    </p>
  </div>
  <!-- Botón WhatsApp -->
  <a href="#" class="whatsapp-button" target="_blank" >

    <i class="fab fa-whatsapp"></i>
  </a>

<script>
let products = [];
let overlayLoadToken = 0;
let currentSlide = 0;


const formatter = new Intl.NumberFormat('es-AR', {
  minimumFractionDigits: 0,
  maximumFractionDigits: 0
});


// Convierte CSV en array de objetos
function parseCSV(text) {
  const [headerLine, ...lines] = text.trim().split("\n");
  const headers = headerLine.split(",");
  return lines.map(l => {
    const cols = l.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim());
    obj.price = obj.price ? parseFloat(obj.price) : null;
    return obj;
  });
}

// Carga catálogo desde CSV
async function loadCatalog() {
  const res = await fetch("data/products.csv");
  const text = await res.text();
  products = parseCSV(text);
  renderCatalog(products);
  cargarCategorias();
}

// Renderiza el catálogo
function renderCatalog(list) {
  const container = document.getElementById("catalog");
  const emptyMsg = document.getElementById("emptyMessage");
  container.innerHTML = "";

  if (list.length === 0) {
    emptyMsg.style.display = "block";
    return;
  } else {
    emptyMsg.style.display = "none";
  }

  list.forEach(p => {
    const card = document.createElement("article");
    card.className = "card";
    card.dataset.name = p.name;
    card.dataset.price = p.price;
    const displayPrice = p.price !== null ? p.price !== -1 ? `$${formatter.format(p.price)}` : "Reservado" : "Consultar";

    // Construcción segura del contenido
    const img = document.createElement("img");
    img.src = `static/images/${p.id}.jpeg`;
    img.alt = `${p.name} - ${p.category}`;
    img.loading = "lazy";
    img.onerror = () => img.src = 'static/images/sinImagen.jpeg';

    const meta = document.createElement("div");
    meta.className = "meta";

    meta.innerHTML = `
      <div class="title">${p.name}</div>
      <div style="font-size:13px; color:var(--muted)">${p.category}</div>
      <div style="font-size:13px; color:#444">${p.description}</div>
      <div style="font-size:13px; color:#444">Dimensiones: ${p.size}</div>
      <div class="price">Precio: ${displayPrice}</div>
    `;

    card.appendChild(img);
    card.appendChild(meta);
    card.addEventListener("click", () => openOverlay(p));
    container.appendChild(card);
  });
}

loadCatalog();

// Carrusel: cambia imagen activa
function changeSlide(step) {
  const imgs = document.querySelectorAll('#carouselImages img');
  if (!imgs.length) return;
  imgs[currentSlide].classList.remove('active');
  currentSlide = (currentSlide + step + imgs.length) % imgs.length;
  imgs[currentSlide].classList.add('active');
}

// Verifica existencia de imagen
async function checkImageExists(url) {
  try {
    const res = await fetch(url, { method: 'HEAD' });
    return res.ok;
  } catch {
    return false;
  }
}

// Resuelve ruta de imagen
function resolveImagePath(file) {
  if (!file) return file;
  if (file.startsWith('http') || file.startsWith('/') || file.includes('/')) return file;
  return 'static/images/' + file;
}

// Carga imágenes del producto en carrusel
async function loadProductImages(baseImage, token) {
  const container = document.getElementById('carouselImages');
  container.innerHTML = '<div class="loading">Cargando imágenes...</div>';
  if (!baseImage) { container.innerHTML = '<div class="empty">Sin imagen</div>'; return; }

  // Si no cumple patrón, usar imagen base directamente
  const m = baseImage.match(/^(.*?)(-\d+)?(\.[^.]+)$/);
  const baseName = m ? m[1] : baseImage.replace(/\.[^.]+$/, '');
  const ext = m ? m[3] : '.jpeg';

  const imagesFound = [];
  const basePath = resolveImagePath(baseImage);
  if (token !== overlayLoadToken) return;
  if (await checkImageExists(basePath)) imagesFound.push(basePath);

  const maxExtra = 15;
  for (let i = 1; i <= maxExtra; i++) {
    if (token !== overlayLoadToken) return;
    const candidate = resolveImagePath(baseName + '-' + i + ext);
    if (await checkImageExists(candidate)) imagesFound.push(candidate);
    else break;
  }

  container.innerHTML = '';
  if (!imagesFound.length) {
    container.innerHTML = '<div class="empty">No hay imágenes</div>';
    return;
  }

  imagesFound.forEach((src, idx) => {
    const img = document.createElement('img');
    img.src = src;
    img.loading = "lazy";
    if (idx === 0) img.classList.add('active');
    container.appendChild(img);
  });

  currentSlide = 0;
  document.getElementById('prevBtn').style.display = imagesFound.length > 1 ? 'block' : 'none';
  document.getElementById('nextBtn').style.display = imagesFound.length > 1 ? 'block' : 'none';
}

// Abre overlay con datos del producto
async function openOverlay(product) {
  const token = ++overlayLoadToken;
  document.getElementById('overlayName').textContent = product.name || '';
  document.getElementById('overlayDescription').textContent = product.description || '';
  document.getElementById('overlaySize').textContent = 'Dimensiones: ' + (product.size || '');
  
  const overlayPrice = (product.price && !isNaN(product.price)) ? (product.price && !isNaN(product.price) && product.price != -1) ? `$${formatter.format(product.price)}` : 'Reservado' : 'Consultar';
  document.getElementById('overlayPrice').textContent = 'Precio: ' + overlayPrice;
  document.getElementById('productOverlay').style.display = 'flex';
  await loadProductImages(`${product.id}.jpeg`, token);
}

// Cierra overlay
function closeOverlay() {
  overlayLoadToken++;
  document.getElementById('productOverlay').style.display = 'none';
  document.getElementById('carouselImages').innerHTML = '';
}

// WhatsApp link dinámico
const phone = "5491133515673";
const message = "Hola, quiero más información.";
document.querySelector(".whatsapp-button").setAttribute("href", `https://wa.me/${phone}?text=${encodeURIComponent(message)}`);

// Filtro por categoría y búsqueda
function cargarCategorias() {
  const categorias = [...new Set(products.map(p => p.category).filter(Boolean))];
  const selectCat = document.createElement("select");
  selectCat.id = "filterCategory";
  selectCat.className = "select";
  selectCat.innerHTML = `<option value="all">Todas las categorías</option>` +
    categorias.map(cat => `<option value="${cat}">${cat}</option>`).join('');
  document.querySelector(".controls").appendChild(selectCat);

  selectCat.addEventListener("change", applyFilters);
  document.getElementById("sort").addEventListener("change", applyFilters);
  document.getElementById("search").addEventListener("input", debounce(applyFilters, 300));
}

// Aplica filtros y ordenamiento
function applyFilters() {
  let filtered = [...products];
  const term = document.getElementById("search").value.toLowerCase();
  const selectedCategory = document.getElementById("filterCategory")?.value || "all";
  const sortValue = document.getElementById("sort").value;

  if (selectedCategory !== "all") filtered = filtered.filter(p => p.category === selectedCategory);
  if (term) filtered = filtered.filter(p => p.name.toLowerCase().includes(term));

  switch (sortValue) {
    case "price_asc": filtered.sort((a, b) => (a.price || 0) - (b.price || 0)); break;
    case "price_desc": filtered.sort((a, b) => (b.price || 0) - (a.price || 0)); break;
    case "name_asc": filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
    case "name_desc": filtered.sort((a, b) => b.name.localeCompare(a.name)); break;
  }

  renderCatalog(filtered);
}

// Debounce para búsqueda
function debounce(fn, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}
</script>
</body>
</html>
